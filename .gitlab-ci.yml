variables:
  SPEC_DIR: /home/gitlab-runner/owncloud-apps
  GIT_STRATEGY: clone

before_script:
  - echo "before"
  - docker rm --force owncloud-irods-meta-builder || echo "not running"

after_script:
  - echo "after"
  - docker rm --force owncloud-irods-meta-builder || echo "not running"

stages:
  - build_containers
  - build_rpms
  - build_image
  - push_image

build-containers:
  stage: build_containers
  tags:
    - owncloud
  script:
    cd /home/gitlab-runner/owncloud-apps/localbuild
    docker build -t owncloud-rpm-builder .

build-rpm:
  stage: build_rpms
  tags:
    - owncloud
  variables:
    RPM: owncloud-irods_meta-${CI_COMMIT_REF_NAME}-${CI_PIPELINE_ID}.noarch.rpm
  script:
    - docker run -v ${SPEC_DIR}:/host --name owncloud-irods-meta-builder owncloud-rpm-builder rpmbuild -ba /host/SPECS/owncloud-irods-meta.spec --define "version $CI_COMMIT_REF_NAME" --define "release $CI_PIPELINE_ID" --define "branch $CI_COMMIT_REF_NAME"
    - docker cp owncloud-irods-meta-builder:/home/builder/rpm/noarch/${RPM} .
    - cp ${RPM} /home/gitlab-runner/irods-owncloud-integration/docker/owncloud-acceptance/RPM/owncloud-irods_meta.noarch.rpm
  
build-image:
  stage: build_image
  tags:
    - owncloud
  script:
    - cd /home/gitlab-runner/irods-owncloud-integration/docker/owncloud-acceptance
    - docker build -t git.ia.surfsara.nl:5050/data-management-services/irods-owncloud-integration .

push-image:
  stage: push_image
  tags:
    - owncloud
  script:
    - docker push git.ia.surfsara.nl:5050/data-management-services/irods-owncloud-integration
